name: Update version tag on test server

on:
    create:
        tags:
            - 'v*'

jobs:
     update-tag-on-server:
        runs-on: self-hosted
        if: github.event.ref_type == 'tag'

        steps:
            -   name: Extract tag name
                run: |
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ç–µ–≥–∞ –∏–∑ ref
                    TAG_NAME=${GITHUB_REF#refs/tags/}
                    echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
                    echo "‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–≥: $TAG_NAME"

            -   name: Load server configuration and check assignment
                run: |
                    if [ ! -f "/root/.env.servers" ]; then
                      echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ .env.servers –Ω–µ –Ω–∞–π–¥–µ–Ω!"
                      exit 1
                    fi

                    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env.servers
                    set -a
                    source /root/.env.servers
                    set +a

                    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∞
                    HOST_VAR="TEST_HOST"
                    PASSWORD_VAR="TEST_PASSWORD"

                    # –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
                    eval "SERVER_HOST=\$$HOST_VAR"
                    eval "SERVER_PASSWORD=\$$PASSWORD_VAR"

                    if [ -z "$SERVER_HOST" ] || [ -z "$SERVER_PASSWORD" ]; then
                      echo "‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
                      echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ .env.servers –µ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: ${HOST_VAR} –∏ ${PASSWORD_VAR}"
                      exit 1
                    fi

                    echo "SERVER_HOST=$SERVER_HOST" >> $GITHUB_ENV
                    echo "SERVER_PASSWORD=$SERVER_PASSWORD" >> $GITHUB_ENV
                    echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞: $SERVER_HOST"

            -   name: Update tag on test server
                run: |
                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º sshpass –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ –ø–∞—Ä–æ–ª—é
                    sshpass -p "${{ env.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no root@${{ env.SERVER_HOST }} -p 22 << 'EOF'

                    cd kontur/kontur-tg-bot
                    git fetch origin --tags

                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É/—Ç–µ–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    CURRENT_REF=$(git symbolic-ref --short HEAD 2>/dev/null || git describe --tags --exact-match 2>/dev/null || git rev-parse --short HEAD)
                    echo "üîç –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: $CURRENT_REF"

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–≥
                    if ! git tag -l | grep -q "^${{ env.TAG_NAME }}$"; then
                        echo "‚ùå –¢–µ–≥ ${{ env.TAG_NAME }} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏!"
                        exit 1
                    fi

                    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ç–µ–≥
                    echo "üè∑Ô∏è –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ç–µ–≥ ${{ env.TAG_NAME }}"
                    git checkout ${{ env.TAG_NAME }}

                    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤–µ—Ç–∫–∏ (–∫—Ä–æ–º–µ main/master)
                    echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤–µ—Ç–∫–∏"
                    git for-each-ref --format='%(refname:short)' refs/heads | grep -v -E "^(main|master)$" | xargs -r git branch -D

                    # –û—á–∏—â–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ –≤–µ—Ç–∫–∏
                    git remote prune origin

                    echo "‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ç–µ–≥ ${{ env.TAG_NAME }} –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

                    cd ../kontur-system

                    export $(cat env/.env.app env/.env.db env/.env.monitoring | xargs)

                    echo "üî® –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —Ç–µ–≥–∞ ${{ env.TAG_NAME }}..."
                    docker compose -f ./docker-compose/app.yaml up -d --build kontur-tg-bot

                    check_health() {
                        # –ï—Å–ª–∏ –µ—Å—Ç—å HTTP endpoint
                        if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:8005/api/tg-bot/health | grep -q "200"; then
                            return 0
                        else
                            return 1
                        fi
                    }

                    MAX_ATTEMPTS=3
                    ATTEMPT=1
                    SUCCESS=false

                    sleep 10

                    while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
                        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ health (–ø–æ–ø—ã—Ç–∫–∞ $ATTEMPT –∏–∑ $MAX_ATTEMPTS)..."

                        if check_health; then
                            echo "‚úÖ Health check –ø—Ä–æ–π–¥–µ–Ω!"
                            SUCCESS=true
                            break
                        else
                            echo "‚è≥ Health check –Ω–µ –ø—Ä–æ–π–¥–µ–Ω, –∂–¥–µ–º..."
                            sleep 15
                        fi

                        ATTEMPT=$((ATTEMPT + 1))
                    done

                    if [ "$SUCCESS" = false ]; then
                        echo "‚ùå Health check –Ω–µ –ø—Ä–æ–π–¥–µ–Ω –ø–æ—Å–ª–µ $MAX_ATTEMPTS –ø–æ–ø—ã—Ç–æ–∫"
                        echo "üìã –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
                        docker logs --tail 50 kontur-tg-bot
                        python3 script/tg_bot_alert.py "‚ùå –¢–µ–≥ kontur-tg-bot/${{ env.TAG_NAME }} –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ${{ env.SERVER_HOST }}!
                    üìã –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

                        exit 1
                    fi

                    echo "‚úÖ –¢–µ–≥ ${{ env.TAG_NAME }} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
                    python3 script/tg_bot_alert.py "‚úÖ –¢–µ–≥ kontur-tg-bot/${{ env.TAG_NAME }} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ${{ env.SERVER_HOST }}!"
                    EOF

            -   name: Verify deployment
                run: |
                    echo "üéâ –î–µ–ø–ª–æ–π —Ç–µ–≥–∞ ${{ env.TAG_NAME }} –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"
                    echo "üìä –°–µ—Ä–≤–µ—Ä: ${{ env.SERVER_HOST }}"
                    echo "üè∑Ô∏è –í–µ—Ä—Å–∏—è: ${{ env.TAG_NAME }}"