name: –î–µ–ø–ª–æ–π –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ–≥–∞ –Ω–∞ stage —Å–µ—Ä–≤–µ—Ä

on:
    create:
        tags:
            - 'v*'

env:
    SERVICE_NAME: ${{ github.event.repository.name }}
    SYSTEM_REPO: loom-system
    TAG_NAME: ${{ github.ref_name }}

jobs:
    deploy-to-stage:
        runs-on: self-hosted
        if: github.event.ref_type == 'tag'

        steps:
            - name: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–≥–∞
              run: |
                  if [[ ! "${{ env.TAG_NAME }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
                    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–≥–∞: ${{ env.TAG_NAME }}"
                    echo "   –û–∂–∏–¥–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç: v1.0.0"
                    exit 1
                  fi
                  echo "‚úÖ –§–æ—Ä–º–∞—Ç —Ç–µ–≥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: ${{ env.TAG_NAME }}"

            - name: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ç–µ–≥–∞
              run: |
                  TAG_NAME=${GITHUB_REF#refs/tags/}
                  echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
                  echo "::notice title=–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–∞::–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–µ–≥: $TAG_NAME"

            - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞
              run: |
                  source .github/scripts/on-create-version-tag/load_config.sh
                  load_server_config

            - name: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ —Ä–µ–ª–∏–∑–µ
              run: |
                  source .github/scripts/on-create-version-tag/release_tg_bot_api.sh
                  create_release_record

            - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "—Å–±–æ—Ä–∫–∞"
              run: |
                  source .github/scripts/on-create-version-tag/release_tg_bot_api.sh
                  update_release_status "building"

            - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
              id: refresh_db_step
              run: |
                  source .github/scripts/on-create-version-tag/refresh_db.sh
                  refresh_all_databases

            - name: –î–µ–ø–ª–æ–π –Ω–∞ stage —Å–µ—Ä–≤–µ—Ä
              id: deploy_step
              run: |
                  source .github/scripts/on-create-version-tag/deploy.sh
                  deploy_to_server

            - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
              if: steps.deploy_step.outcome == 'success'
              run: |
                  source .github/scripts/on-create-version-tag/release_tg_bot_api.sh
                  update_release_status "stage_deployed"

            - name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–∫–∞—Ç–∞
              id: rollback_test_step
              if: steps.deploy_step.outcome == 'success'
              run: |
                  source .github/scripts/on-create-version-tag/rollback.sh
                  
                  # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥ –¥–ª—è —Ç–µ—Å—Ç–∞ –æ—Ç–∫–∞—Ç–∞
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${{ env.TAG_NAME }}^ 2>/dev/null || echo "")
                  
                  if [ -z "$PREVIOUS_TAG" ]; then
                    echo "‚ö†Ô∏è –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –æ—Ç–∫–∞—Ç–∞"
                    echo "ROLLBACK_SKIPPED=true" >> $GITHUB_ENV
                    exit 0
                  fi
                  
                  echo "üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–∫–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥: $PREVIOUS_TAG"
                  echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV
                  
                  rollback_with_status_tracking "$RELEASE_ID" "$SERVICE_NAME" "$PREVIOUS_TAG" "$SYSTEM_REPO"

            - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–∫–∞—Ç–∞
              if: steps.rollback_test_step.outcome == 'success' && env.ROLLBACK_SKIPPED != 'true'
              run: |
                  echo "‚úÖ –¢–µ—Å—Ç –æ—Ç–∫–∞—Ç–∞ –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ"
                  echo "   –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: ${{ env.TAG_NAME }}"
                  echo "   –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –æ—Ç–∫–∞—Ç –Ω–∞: ${{ env.PREVIOUS_TAG }}"
                  echo "   –°–µ—Ä–≤–∏—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é"

            - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "—Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
              if: success()
              run: |
                  source .github/scripts/on-create-version-tag/release_tg_bot_api.sh
                  update_release_status "manual_testing"

            - name: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
              if: success()
              run: |
                  source .github/scripts/on-create-version-tag/deploy.sh
                  verify_deployment_success

            - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
              if: failure()
              run: |
                  source .github/scripts/on-create-version-tag/release_tg_bot_api.sh
                  
                  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
                  if [ "${{ steps.deploy_step.outcome }}" == "failure" ]; then
                    update_release_status "staging_failed"
                  elif [ "${{ steps.rollback_test_step.outcome }}" == "failure" ]; then
                    update_release_status "stage_rollback_test_failed"
                  else
                    update_release_status "staging_failed"
                  fi

            - name: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –¥–µ–ø–ª–æ—è
              if: failure()
              run: |
                  source .github/scripts/on-create-version-tag/deploy.sh
                  handle_deployment_failure

            - name: –°–≤–æ–¥–∫–∞ –ø–æ –¥–µ–ø–ª–æ—é
              if: always()
              run: |
                  echo "========================================="
                  echo "üìã –°–≤–æ–¥–∫–∞ –ø–æ –¥–µ–ø–ª–æ—é"
                  echo "========================================="
                  echo "–°–µ—Ä–≤–∏—Å: ${{ env.SERVICE_NAME }}"
                  echo "–¢–µ–≥: ${{ env.TAG_NAME }}"
                  echo "ID —Ä–µ–ª–∏–∑–∞: ${{ env.RELEASE_ID }}"
                  echo "Stage —Ö–æ—Å—Ç: ${{ env.STAGE_HOST }}"
                  echo "Stage –¥–æ–º–µ–Ω: ${{ env.STAGE_DOMAIN }}"
                  echo ""
                  echo "–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏: ${{ job.status }}"
                  echo "–®–∞–≥ –¥–µ–ø–ª–æ—è: ${{ steps.deploy_step.outcome }}"
                  echo "–¢–µ—Å—Ç –æ—Ç–∫–∞—Ç–∞: ${{ steps.rollback_test_step.outcome }}"
                  echo ""
                  echo "üìÅ –õ–æ–≥–∏:"
                  echo "   –î–µ–ø–ª–æ–π: /var/log/deployments/${{ env.SERVICE_NAME }}/${{ env.TAG_NAME }}.log"
                  if [ -n "${{ env.PREVIOUS_TAG }}" ]; then
                    echo "   –¢–µ—Å—Ç –æ—Ç–∫–∞—Ç–∞: /var/log/deployments/rollback/${{ env.SERVICE_NAME }}/${{ env.PREVIOUS_TAG }}-rollback.log"
                  fi
                  echo "========================================="

            - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
              if: success()
              run: |
                  echo "üéâ –ü–∞–π–ø–ª–∞–π–Ω –¥–µ–ø–ª–æ—è –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
                  echo ""
                  echo "‚úÖ –¢–µ–≥ ${{ env.TAG_NAME }} —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ stage"
                  echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
                  echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω—ã"
                  if [ "${{ env.ROLLBACK_SKIPPED }}" != "true" ]; then
                    echo "‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
                  fi
                  echo ""
                  echo "üëâ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
                  echo "üëâ –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω"

            - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
              if: failure()
              run: |
                  echo "‚ùå –ü–∞–π–ø–ª–∞–π–Ω –¥–µ–ø–ª–æ—è –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
                  echo ""
                  if [ "${{ steps.deploy_step.outcome }}" == "failure" ]; then
                    echo "–û—à–∏–±–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ: –î–µ–ø–ª–æ–π –Ω–∞ stage"
                  elif [ "${{ steps.rollback_test_step.outcome }}" == "failure" ]; then
                    echo "–û—à–∏–±–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ: –¢–µ—Å—Ç –æ—Ç–∫–∞—Ç–∞"
                  else
                    echo "–û—à–∏–±–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç—Ç–∞–ø"
                  fi
                  echo ""
                  echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π:"
                  echo "   GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  echo "   –õ–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: /var/log/deployments/${{ env.SERVICE_NAME }}/${{ env.TAG_NAME }}.log"